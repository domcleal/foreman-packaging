From 9f5f81874517a515b3c8468415daa77bed742b5d Mon Sep 17 00:00:00 2001
From: Lukas Zapletal <lzap+git@redhat.com>
Date: Mon, 9 Jun 2014 11:56:22 +0200
Subject: [PATCH] Fixed loading of namespaced gems and added BEXT_VERBOSE

---
 lib/bundler_ext/output.rb  |  5 +++++
 lib/bundler_ext/runtime.rb | 19 +++++++++++--------
 2 files changed, 16 insertions(+), 8 deletions(-)

diff --git a/lib/bundler_ext/output.rb b/lib/bundler_ext/output.rb
index 95283b7..2869e41 100644
--- a/lib/bundler_ext/output.rb
+++ b/lib/bundler_ext/output.rb
@@ -2,6 +2,7 @@ module BundlerExt
   class Output
     def self.parse_env
       @nostrict = ENV['BEXT_NOSTRICT'] || ENV['BUNDLER_EXT_NOSTRICT']
+      @verbose = ENV['BEXT_VERBOSE'] || ENV['BUNDLER_EXT_VERBOSE']
     end
 
     def self.strict_err(msg)
@@ -12,5 +13,9 @@ def self.strict_err(msg)
         raise msg
       end
     end
+
+    def self.verbose_msg(msg)
+      puts msg if @verbose
+    end
   end
 end
diff --git a/lib/bundler_ext/runtime.rb b/lib/bundler_ext/runtime.rb
index f65fdf4..61336b3 100644
--- a/lib/bundler_ext/runtime.rb
+++ b/lib/bundler_ext/runtime.rb
@@ -37,17 +37,20 @@ def system_require(files)
       files.each do |dep|
         # this part also take from lib/bundler/runtime.rb (github/master)
         begin
-          #puts "Attempting to require #{dep}"
+          Output.verbose_msg "Attempting to require #{dep}"
           require dep
-        rescue LoadError => e
-          namespaced_file = self.class.namespaced_file(dep)
+        rescue LoadError => err_regular
           begin
-            require namespaced_file unless namespaced_file.nil?
-          rescue LoadError => e2
-            e = e2
+            namespaced_file = self.class.namespaced_file(dep)
+            if namespaced_file.nil?
+              Output.strict_err "Gem loading error: #{err_regular.message}"
+            else
+              Output.verbose_msg "Attempting to require #{namespaced_file}"
+              require namespaced_file
+            end
+          rescue LoadError => err_namespaced
+            Output.strict_err "Gem loading error: #{err_namespaced.message}"
           end
-
-          Output.strict_err "Gem loading error: #{e.message}"
         end
       end
     end
